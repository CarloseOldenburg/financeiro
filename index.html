<!doctype html>
};


function parseJwt(token){ const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c){return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)}).join('')); return JSON.parse(jsonPayload); }


async function api(action, params={}){
if(!ID_TOKEN){ alert('Faça login com Google.'); throw new Error('not-auth'); }
const body = new URLSearchParams({ action, id_token: ID_TOKEN, ...params });
const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
const data = await res.json(); if(!data.ok) throw new Error(data.error||'Erro API'); return data;
}


// Form – adicionar lançamento
const form = $('#formLanc');
form.addEventListener('submit', async (e)=>{
e.preventDefault();
const payload = {
tipo: $('#tipo').value,
categoria: $('#categoria').value,
valor: parseFloat($('#valor').value),
descricao: $('#descricao').value,
conta: $('#conta').value,
tags: $('#tags').value
};
await api('add', { payload: JSON.stringify(payload) });
form.reset();
$('#btAdd').classList.add('pointer-events-none');
$('#btAdd').animate([{transform:'scale(1)'},{transform:'scale(1.04)'}],{duration:120}).addEventListener('finish',()=>$('#btAdd').classList.remove('pointer-events-none'));
toast('Lançamento adicionado');
refresh();
});


// Orçamento
const formB = $('#formBudget');
formB.addEventListener('submit', async (e)=>{
e.preventDefault();
const payload = { categoria: $('#bCategoria').value, valor_mensal: parseFloat($('#bValor').value) };
await api('setBudget', { payload: JSON.stringify(payload) });
toast('Orçamento salvo');
refresh();
});


// Atualizar
$('#btAtualizar').addEventListener('click', ()=> refresh());


let pieChart, lineChart;
async function refresh(){
const ano = $('#fAno').value; const mes = $('#fMes').value;
const list = await api('list', { ano, mes });
const sum = await api('summary', { ano, mes });


// Tabela
const tbody = $('#tbody'); tbody.innerHTML='';
list.items.forEach(it=>{
const tr = document.createElement('tr'); const d = new Date(it.timestamp);
tr.innerHTML = `
<td>${d.toLocaleDateString('pt-BR')}</td>
<td><span class="${it.tipo==='despesa'?'text-rose-400':'text-emerald-400'}">${it.tipo}</span></td>
<td>${it.categoria}</td>
<td class="opacity-90">${it.descricao||''}</td>
<td class="text-right font-medium">${brl(it.valor)}</td>`;
tbody.appendChild(tr);
});


// Gráficos
const cats = Object.keys(sum.porCategoria||{}); const vals = cats.map(c=> sum.porCategoria[c]);
if(pieChart) pieChart.destroy();
pieChart = new Chart($('#pie'), { type:'pie', data:{ labels:cats, datasets:[{ data: vals }] }, options:{ plugins:{ legend:{ labels:{ color: getComputedStyle(document.documentElement).getPropertyValue('--text') } } } } });


if(lineChart) lineChart.destroy();
lineChart = new Chart($('#line'), { type:'line', data:{ labels:['Receitas','Despesas','Saldo'], datasets:[{ data:[sum.receitas,sum.despesas,sum.saldo] }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:getComputedStyle(document.documentElement).getPropertyValue('--muted') } }, y:{ ticks:{ color:getComputedStyle(document.documentElement).getPropertyValue('--muted') } } } } });


// Alerts
const box = $('#alerts'); box.innerHTML='';
sum.alerts.forEach(a=>{
const div = document.createElement('div');
div.className = 'p-3 rounded-lg border flex items-center gap-2 ' + (a.tipo==='categoria' ? 'border-red-400/40 bg-red-500/15' : 'border-amber-400/40 bg-amber-500/15');
if(a.tipo==='categoria') div.textContent = `⚠️ Categoria ${a.categoria}: gasto ${brl(a.gasto)} acima do limite ${brl(a.limite)}`;
else div.textContent = `⚠️ Orçamento geral estourado: gastos ${brl(a.gasto)} acima do total permitido ${brl(a.limite)}`;
div.classList.add('pulse');
box.appendChild(div);
});


// Guardar resumo para IA
window.__lastSummary = sum;
}


// IA
$('#btIA').addEventListener('click', async ()=>{
const prompt = $('#prompt').value; const sum = window.__lastSummary || { receitas:0, despesas:0, saldo:0, porCategoria:{}, budgets:{} };
try{
const res = await api('ai', { prompt, summary: JSON.stringify(sum) });
$('#iaOut').textContent = res.text;
}catch(e){ $('#iaOut').textContent = 'IA indisponível: ' + e.message; }
});
</script>
</body>
</html>
